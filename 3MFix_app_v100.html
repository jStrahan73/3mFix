<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>3MFix</title>
<style>
@import url('data:text/css,');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{
  font-family:'Courier New',Courier,monospace;
  background:#0D0D0D;
  display:flex;align-items:center;justify-content:center;
  min-height:100vh;
  transition:background .3s;
}
body.light{background:#C8C8CC;}

/* Phone frame desktop */
@media(min-width:480px){
.phone-wrap{position:relative;width:393px;height:852px;flex-shrink:0;}
.phone-frame{position:absolute;inset:0;border-radius:44px;
background:linear-gradient(135deg,#3A3A3C,#1C1C1E,#3A3A3C);
box-shadow:0 0 50px rgba(138,43,226,.4),0 8px 30px rgba(0,0,0,.9);}
body.light .phone-frame{background:linear-gradient(135deg,#C8C8CC,#A0A0A4,#C8C8CC);}
.sbtn{position:absolute;width:4px;background:#4A4A4C;}
.vup{left:-4px;top:238px;height:36px;border-radius:3px 0 0 3px;}
.vdn{left:-4px;top:315px;height:36px;border-radius:3px 0 0 3px;}
.pwr{right:-4px;top:273px;height:70px;border-radius:0 3px 3px 0;}
.hbar{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);width:134px;height:5px;background:rgba(255,255,255,.35);border-radius:3px;z-index:10;}
.screen{position:absolute;left:10px;top:10px;width:373px;height:832px;border-radius:34px;overflow:hidden;}
.island{position:absolute;top:22px;left:50%;transform:translateX(-50%);width:120px;height:34px;background:#000;border-radius:20px;z-index:20;pointer-events:none;}
}
@media(max-width:479px){
body{align-items:flex-start;background:#0A0A0A;}
body.light{background:#F5F5F7;}
.phone-wrap{width:100%;min-height:100vh;}
.phone-frame,.sbtn,.hbar,.island{display:none;}
.screen{position:relative;width:100%;min-height:100vh;}
}

.screen{background:#0A0A0A;transition:background .3s;display:flex;flex-direction:column;}
body.light .screen{background:#F5F5F7;}

.blob{position:fixed;width:280px;height:280px;border-radius:50%;pointer-events:none;z-index:0;}
.blob-tl{top:-80px;left:-80px;background:rgba(138,43,226,.12);}
.blob-br{bottom:-80px;right:-80px;background:rgba(0,191,255,.12);}
body.light .blob-tl{background:rgba(138,43,226,.07);}
body.light .blob-br{background:rgba(0,191,255,.07);}

.scroll{position:relative;z-index:1;flex:1;overflow-y:auto;scrollbar-width:none;}
.scroll::-webkit-scrollbar{display:none;}
.inner{padding:0 12px 32px;}

/* Header */
.hdr{display:flex;align-items:center;gap:8px;padding:56px 16px 16px;border-bottom:1px solid rgba(138,43,226,.3);background:inherit;}
@media(max-width:479px){.hdr{padding-top:20px;}}
body.light .hdr{border-color:rgba(138,43,226,.2);}
.logo{flex:1;display:flex;flex-direction:column;gap:2px;}
.logo-name{font-size:22px;font-weight:900;letter-spacing:2px;
background:linear-gradient(90deg,#8A2BE2,#00BFFF,#FF1493);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.logo-ver{font-size:10px;font-weight:500;letter-spacing:1px;color:#9AA2B5;-webkit-text-fill-color:#9AA2B5;}
body.light .logo-ver{color:#6B7280;-webkit-text-fill-color:#6B7280;}
.hbtn{width:44px;height:44px;border-radius:8px;background:rgba(20,20,20,.8);
border:1px solid rgba(138,43,226,.3);display:flex;align-items:center;justify-content:center;
cursor:pointer;color:#fff;font-size:18px;flex-shrink:0;transition:background .3s,color .3s;
-webkit-tap-highlight-color:transparent;user-select:none;}
body.light .hbtn{background:rgba(240,240,243,.9);border-color:rgba(138,43,226,.2);color:#1A1A1A;}

/* Cards */
.card{background:rgba(20,20,20,.6);border-radius:16px;border:1px solid rgba(138,43,226,.3);
margin-top:20px;overflow:hidden;transition:opacity .4s;}
body.light .card{background:rgba(255,255,255,.9);border-color:rgba(138,43,226,.2);}
.card.locked{opacity:.4;pointer-events:none;}
.chdr{display:flex;align-items:center;gap:14px;padding:14px 16px;
background:linear-gradient(90deg,rgba(138,43,226,.1),rgba(0,191,255,.1));
border-bottom:1px solid rgba(138,43,226,.3);}
body.light .chdr{border-color:rgba(138,43,226,.2);}
.badge{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,#8A2BE2,#00BFFF);
display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:#fff;
box-shadow:0 0 12px rgba(138,43,226,.5);flex-shrink:0;}
.ctitle{font-size:14px;font-weight:700;color:#fff;letter-spacing:1px;transition:color .3s;}
body.light .ctitle{color:#1A1A1A;}
.cbody{padding:16px;}

/* Drop zone */
.dz{border-radius:10px;border:2px solid transparent;transition:border-color .2s,background .2s;padding:2px;}
.dz.active{border-color:#00BFFF;background:rgba(0,191,255,.08);}
.dhint{text-align:center;font-size:11px;color:#9AA2B5;margin-top:8px;}
body.light .dhint{color:#6B7280;}

/* Buttons */
.btn{display:flex;align-items:center;justify-content:center;width:100%;height:44px;border-radius:10px;
font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;border:none;
transition:transform .1s;-webkit-tap-highlight-color:transparent;user-select:none;}
.btn:active{transform:scale(.97);}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.bpri{background:linear-gradient(135deg,#8A2BE2,#00BFFF);color:#fff;box-shadow:0 0 16px rgba(138,43,226,.4);}
.bgrn{background:linear-gradient(135deg,#00FF88,#00CC6A);color:#000;box-shadow:0 0 16px rgba(0,255,136,.3);}
.bred{background:linear-gradient(135deg,#FF006E,#CC0055);color:#fff;}
.borg{background:linear-gradient(135deg,#FF8800,#FF6600);color:#fff;box-shadow:0 0 12px rgba(255,136,0,.3);}
.bloaded{background:linear-gradient(135deg,#00FF88,#00CC6A);color:#000;}

.ibtns{display:flex;gap:8px;justify-content:center;margin:14px 0;}
.ibtnwrap{display:flex;flex-direction:column;align-items:center;gap:5px;}
.ibtnlbl{font-size:10px;color:#9AA2B5;letter-spacing:.3px;transition:color .3s;white-space:nowrap;}
body.light .ibtnlbl{color:#6B7280;}
.ibtn{width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;
font-size:18px;cursor:pointer;border:none;transition:transform .1s;
-webkit-tap-highlight-color:transparent;user-select:none;}
.ibtn:active{transform:scale(.9);}
.ibtn:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.igrn{background:linear-gradient(135deg,#00FF88,#00CC6A);box-shadow:0 0 12px rgba(0,255,136,.3);}
.iorg{background:linear-gradient(135deg,#FF8800,#FF6600);box-shadow:0 0 12px rgba(255,136,0,.3);}
.ired{background:linear-gradient(135deg,#FF006E,#CC0055);box-shadow:0 0 12px rgba(255,0,110,.3);}
.icyn{background:linear-gradient(135deg,#00BFFF,#0088CC);box-shadow:0 0 12px rgba(0,191,255,.3);}

/* Console */
.con{background:rgba(5,5,5,.95);border-radius:8px;border:1px solid rgba(138,43,226,.2);
padding:10px 12px;margin-top:12px;font-size:11px;line-height:1.75;min-height:52px;}
body.light .con{background:#F0F0F3;border-color:rgba(138,43,226,.15);}
.ls{color:#00FF88;}.li{color:#9AA2B5;}.lw{color:#FFAA00;}.le{color:#FF6B6B;}
body.light .li{color:#6B7280;}

/* Toggles */
.trow{display:flex;align-items:center;justify-content:space-between;padding:10px 0;
border-bottom:1px solid rgba(68,68,68,.4);cursor:pointer;
-webkit-tap-highlight-color:transparent;user-select:none;}
.trow:last-child{border-bottom:none;}
body.light .trow{border-color:rgba(229,231,235,.8);}
.trow.dis{opacity:.35;pointer-events:none;}
.tlbl{font-size:13px;color:#E0E0E0;transition:color .3s;}
body.light .tlbl{color:#3D3D3D;}
.ttrack{width:42px;height:24px;border-radius:12px;background:rgba(50,50,50,.8);
position:relative;flex-shrink:0;transition:background .25s;}
body.light .ttrack{background:#D1D5DB;}
.ttrack.on{background:linear-gradient(90deg,#8A2BE2,#00BFFF);}
.tknob{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;
background:#666;transition:transform .25s,background .25s;}
.ttrack.on .tknob{background:#fff;transform:translateX(18px);}

/* Indent */
.indent{margin:0 0 8px 12px;padding:12px;border-left:2px solid rgba(138,43,226,.3);}
.slbl{font-size:11px;color:#9AA2B5;margin-bottom:6px;}
body.light .slbl{color:#6B7280;}
.gsel{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(138,43,226,.3);
background:rgba(10,10,10,.8);color:#E0E0E0;font-family:inherit;font-size:13px;
appearance:none;outline:none;}
body.light .gsel{background:#F0F0F3;color:#1A1A1A;border-color:rgba(138,43,226,.2);}

/* Input */
.ginp{width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(138,43,226,.3);
background:rgba(10,10,10,.8);color:#E0E0E0;font-family:inherit;font-size:13px;outline:none;}
body.light .ginp{background:#F0F0F3;color:#1A1A1A;border-color:rgba(138,43,226,.2);}
.ginp::placeholder{color:#9AA2B5;}
.ginp:focus{border-color:#8A2BE2;}

/* Progress */
.ptrack{height:6px;border-radius:3px;background:rgba(10,10,10,.8);margin:14px 0;overflow:hidden;}
body.light .ptrack{background:#E5E7EB;}
.pfill{height:100%;background:linear-gradient(90deg,#8A2BE2,#00BFFF,#FF1493);
border-radius:3px;width:0%;transition:width .6s ease;}

/* Modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:100;
display:none;align-items:center;justify-content:center;padding:16px;}
.overlay.show{display:flex;}
.modal{background:#141414;border-radius:16px;border:1px solid rgba(138,43,226,.4);
width:100%;max-width:420px;max-height:85vh;display:flex;flex-direction:column;
box-shadow:0 0 40px rgba(138,43,226,.3);}
body.light .modal{background:#fff;border-color:rgba(138,43,226,.25);}
.mhdr{display:flex;align-items:center;justify-content:space-between;
padding:16px 20px;border-bottom:1px solid rgba(138,43,226,.3);flex-shrink:0;}
body.light .mhdr{border-color:rgba(138,43,226,.2);}
.mttl{font-size:15px;font-weight:700;color:#fff;letter-spacing:1px;transition:color .3s;}
body.light .mttl{color:#1A1A1A;}
.mx{width:32px;height:32px;border-radius:6px;background:rgba(255,255,255,.08);
border:none;color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;
justify-content:center;-webkit-tap-highlight-color:transparent;}
body.light .mx{background:rgba(0,0,0,.06);color:#1A1A1A;}
.mbody{padding:20px;overflow-y:auto;flex:1;scrollbar-width:thin;scrollbar-color:#8A2BE2 transparent;}
.mftr{padding:16px 20px;border-top:1px solid rgba(138,43,226,.3);
display:flex;justify-content:center;gap:10px;flex-shrink:0;}
body.light .mftr{border-color:rgba(138,43,226,.2);}

/* Settings */
.slabel{font-size:13px;font-weight:700;color:#00BFFF;margin-bottom:8px;margin-top:20px;letter-spacing:.5px;}
.trow2{display:flex;border-radius:10px;border:1px solid rgba(138,43,226,.3);overflow:hidden;background:rgba(10,10,10,.8);}
body.light .trow2{background:#F0F0F3;border-color:rgba(138,43,226,.2);}
.topt{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
padding:10px 0;font-size:11px;color:#9AA2B5;cursor:pointer;transition:all .2s;gap:4px;
-webkit-tap-highlight-color:transparent;user-select:none;}
body.light .topt{color:#6B7280;}
.topt.on{background:linear-gradient(135deg,#8A2BE2,#00BFFF);color:#fff;}
.mitem{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:8px;
border:1px solid rgba(138,43,226,.3);background:rgba(138,43,226,.1);margin-bottom:8px;
cursor:pointer;font-size:14px;font-weight:600;color:#fff;
-webkit-tap-highlight-color:transparent;user-select:none;}
body.light .mitem{background:rgba(138,43,226,.08);border-color:rgba(138,43,226,.2);color:#1A1A1A;}
.mitem:active{background:rgba(138,43,226,.25);}
.pcard{background:rgba(138,43,226,.08);border-radius:10px;border:1px solid rgba(138,43,226,.3);
padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
body.light .pcard{background:rgba(138,43,226,.05);border-color:rgba(138,43,226,.2);}
.pname{font-size:13px;font-weight:700;color:#fff;}
body.light .pname{color:#1A1A1A;}
.psub{font-size:11px;color:#9AA2B5;margin-top:2px;}
.dbadge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;
background:linear-gradient(135deg,#8A2BE2,#00BFFF);color:#fff;white-space:nowrap;}
.pacts{margin-left:auto;display:flex;gap:6px;}
.pact{font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid;cursor:pointer;
font-family:inherit;background:transparent;-webkit-tap-highlight-color:transparent;}
.pdef{color:#00BFFF;border-color:rgba(0,191,255,.4);}
.pdel{color:#FF6B6B;border-color:rgba(255,107,107,.4);}
.supcard{padding:16px;border-radius:10px;border:1px solid rgba(255,136,0,.35);
background:rgba(255,136,0,.08);margin-top:20px;}
.supttl{font-size:14px;color:#FF8800;font-weight:700;margin-bottom:6px;}
.supbody{font-size:12px;color:#9AA2B5;line-height:1.5;margin-bottom:14px;}
body.light .supbody{color:#6B7280;}

/* Save printer */
.spcard{background:rgba(138,43,226,.08);border-radius:10px;border:1px solid rgba(138,43,226,.3);
padding:14px;margin-bottom:16px;}
.spmodel{font-size:14px;font-weight:700;color:#fff;margin-bottom:4px;}
body.light .spmodel{color:#1A1A1A;}
.spsub{font-size:12px;color:#9AA2B5;}
.tinline{display:flex;align-items:center;gap:12px;padding:10px 0;cursor:pointer;
-webkit-tap-highlight-color:transparent;user-select:none;}
.tinlinelbl{font-size:13px;color:#E0E0E0;}
body.light .tinlinelbl{color:#3D3D3D;}
.firstnote{font-size:12px;color:#FF8800;font-style:italic;margin-top:6px;}

/* Report */
.rsec{font-size:13px;font-weight:700;color:#8A2BE2;margin-bottom:10px;letter-spacing:.5px;}
.rrow{display:flex;padding:3px 0;font-size:12px;}
.rk{color:#00BFFF;font-weight:600;margin-right:6px;white-space:nowrap;}
.rv{color:#E0E0E0;word-break:break-all;}
body.light .rv{color:#3D3D3D;}
.rv.miss{color:#FF6B6B;}
.rbadge{display:inline-block;margin-top:10px;padding:5px 12px;border-radius:6px;
background:rgba(138,43,226,.15);font-size:12px;color:#00BFFF;}

/* Fit warning */
.ftbl{width:100%;border-collapse:collapse;font-size:12px;margin:12px 0;}
.ftbl th{color:#9AA2B5;text-align:right;padding:6px 8px;border-bottom:1px solid rgba(68,68,68,.4);}
.ftbl th:first-child{text-align:left;}
.ftbl td{padding:6px 8px;text-align:right;color:#E0E0E0;border-bottom:1px solid rgba(68,68,68,.2);}
.ftbl td:first-child{text-align:left;color:#9AA2B5;}
.fexc{color:#FF6B6B!important;font-weight:700;}

/* About/Help/FAQ */
.alogo{font-size:26px;font-weight:900;letter-spacing:3px;
background:linear-gradient(90deg,#8A2BE2,#00BFFF,#FF1493);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
text-align:center;margin-bottom:4px;}
.aver{font-size:13px;color:#8A2BE2;font-weight:600;text-align:center;margin-bottom:16px;}
.btxt{font-size:13px;color:#E0E0E0;line-height:1.6;margin-bottom:12px;}
body.light .btxt{color:#3D3D3D;}
.sttl{font-size:14px;color:#00BFFF;font-weight:700;margin-bottom:8px;margin-top:4px;}
.fitem{display:flex;gap:8px;font-size:13px;color:#9AA2B5;margin-bottom:6px;line-height:1.5;}
body.light .fitem{color:#6B7280;}
.div{height:1px;background:rgba(138,43,226,.2);margin:14px 0;}
.faqq{font-size:14px;color:#00BFFF;font-weight:600;line-height:1.4;margin-bottom:6px;}
.faqa{font-size:12px;color:#9AA2B5;line-height:1.5;}
body.light .faqa{color:#6B7280;}
.ccard{background:rgba(138,43,226,.1);border-radius:8px;border:1px solid rgba(138,43,226,.3);
padding:20px;text-align:center;margin-top:16px;}
.coffee{font-size:36px;display:block;text-align:center;margin:4px 0 12px;}
.dismiss{display:block;text-align:center;font-size:12px;color:#9AA2B5;text-decoration:underline;
cursor:pointer;margin-top:10px;}
</style>

</head>
<body>
<div class="blob blob-tl"></div>
<div class="blob blob-br"></div>

<div class="phone-wrap">
  <div class="phone-frame"></div>
  <div class="sbtn vup"></div><div class="sbtn vdn"></div><div class="sbtn pwr"></div>
  <div class="hbar"></div>
  <div class="screen" id="screen">
    <div class="island"></div>
    <div class="scroll">
      <div class="hdr">
        <div class="logo"><span class="logo-name">3MFix</span><span class="logo-ver">v1.0.0</span></div>
        <div class="hbtn" id="settingsBtn">âš™</div>
      </div>
      <div class="inner">

```
    <!-- Step 1 -->
    <div class="card" id="card1">
      <div class="chdr"><div class="badge">1</div><div class="ctitle">File Selection</div></div>
      <div class="cbody">
        <div class="dz" id="dz">
          <button class="btn bpri" id="chooseBtn">Choose 3MF File</button>
        </div>
        <div class="dhint" id="dhint">or drag &amp; drop a .3mf file onto the phone</div>
        <div class="con" id="con1"><span class="ls">âœ” Ready for file selection</span></div>
        <input type="file" id="fileInput" accept=".3mf" style="display:none">
      </div>
    </div>

    <!-- Step 2 -->
    <div class="card locked" id="card2">
      <div class="chdr"><div class="badge">2</div><div class="ctitle">Options &amp; Process</div></div>
      <div class="cbody">
        <div class="trow dis" id="t-cp" data-key="changePrinter"><span class="tlbl">Change Printer Data</span><div class="ttrack" id="tk-cp"><div class="tknob"></div></div></div>
        <div id="pindent" style="display:none"><div class="indent"><div class="slbl">Select Printer</div><select class="gsel" id="psel"></select></div></div>
        <div class="trow dis" id="t-rp" data-key="removePrinter"><span class="tlbl">Remove Printer Data</span><div class="ttrack" id="tk-rp"><div class="tknob"></div></div></div>
        <div class="trow dis" id="t-rf" data-key="removeFilament"><span class="tlbl">Remove Filament Data</span><div class="ttrack" id="tk-rf"><div class="tknob"></div></div></div>
        <div class="trow dis" id="t-rc" data-key="removeProcess"><span class="tlbl">Remove Process Data</span><div class="ttrack" id="tk-rc"><div class="tknob"></div></div></div>
        <div class="trow dis" id="t-ra" data-key="removeAll"><span class="tlbl">Remove All Data</span><div class="ttrack" id="tk-ra"><div class="tknob"></div></div></div>
        <div style="margin-top:14px"><input class="ginp" id="outName" type="text" placeholder="Output file name"></div>
        <div class="ibtns">
          <div class="ibtnwrap">
            <button class="ibtn igrn" id="processBtn" disabled>â–¶</button>
            <span class="ibtnlbl" id="lbl-process" style="display:none">Process</span>
          </div>
          <div class="ibtnwrap">
            <button class="ibtn iorg" id="reportBtn">ðŸ“„</button>
            <span class="ibtnlbl" id="lbl-report" style="display:none">Report</span>
          </div>
          <div class="ibtnwrap">
            <button class="ibtn ired" id="resetBtn">â†º</button>
            <span class="ibtnlbl" id="lbl-reset" style="display:none">Reset</span>
          </div>
          <div class="ibtnwrap">
            <button class="ibtn icyn" id="restoreBtn" disabled>âŸ³</button>
            <span class="ibtnlbl" id="lbl-restore" style="display:none">Restore</span>
          </div>
        </div>
        <div class="ptrack"><div class="pfill" id="pfill"></div></div>
        <div class="con" id="con2"><span class="li">Â· Waitingâ€¦</span></div>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="card locked" id="card3">
      <div class="chdr"><div class="badge">3</div><div class="ctitle">Export</div></div>
      <div class="cbody">
          <button class="btn bgrn" id="exportBtn">Export 3MF</button>
          <button class="btn" id="debugBtn" style="display:none;margin-top:8px;background:rgba(138,43,226,0.2);border:1px solid rgba(138,43,226,0.4);color:#9AA2B5;font-size:11px;height:34px;">Debug Share Info</button>
          <div class="con" id="debugCon" style="display:none;margin-top:8px;font-size:10px;"></div>
        </div>
    </div>

  </div>
</div>
```

  </div>
</div>

<!-- Modal -->

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="mhdr">
      <span class="mttl" id="mttl"></span>
      <button class="mx" id="mclose">Ã—</button>
    </div>
    <div class="mbody" id="mbody"></div>
    <div class="mftr" id="mftr"></div>
  </div>
</div>

<script>

// â”€â”€â”€ Pure JS DEFLATE (inflate) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function inflateRaw(data) {
  // RFC 1951 DEFLATE decompressor
  let src=0, bits=0, bitbuf=0;
  const out=[];

  function readBits(n){
    while(bits<n){ bitbuf|=data[src++]<<bits; bits+=8; }
    const v=bitbuf&((1<<n)-1); bitbuf>>>=n; bits-=n; return v;
  }
  function readBitsR(n){ // MSB first (for huffman)
    let v=0; for(let i=0;i<n;i++) v=(v<<1)|readBits(1); return v;
  }

  // Build canonical huffman decode table
  function buildTree(lengths){
    const maxLen=Math.max(...lengths);
    const count=new Array(maxLen+1).fill(0);
    for(const l of lengths) if(l) count[l]++;
    const nextCode=new Array(maxLen+1).fill(0);
    let code=0;
    for(let i=1;i<=maxLen;i++){ code=(code+count[i-1])<<1; nextCode[i]=code; }
    const table={};
    for(let i=0;i<lengths.length;i++){
      const l=lengths[i];
      if(l){ table[(nextCode[l]<<(16-l))|(((1<<(16-l))-1))] = {sym:i,len:l}; nextCode[l]++; }
    }
    return {table,maxLen};
  }

  function readSym(tree){
    let code=0,len=0;
    while(len<tree.maxLen){
      code=(code<<1)|readBits(1); len++;
      const key=(code<<(16-len))|(((1<<(16-len))-1));
      if(tree.table[key]&&tree.table[key].len===len) return tree.table[key].sym;
    }
    throw new Error('bad huffman code');
  }

  // Fixed huffman trees (RFC 1951 section 3.2.6)
  function fixedTrees(){
    const ll=new Array(288);
    for(let i=0;i<144;i++)ll[i]=8;
    for(let i=144;i<256;i++)ll[i]=9;
    for(let i=256;i<280;i++)ll[i]=7;
    for(let i=280;i<288;i++)ll[i]=8;
    const dist=new Array(32).fill(5);
    return{ll:buildTree(ll),dist:buildTree(dist)};
  }

  const LEXT=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0];
  const LBASE=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258];
  const DEXT=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];
  const DBASE=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577];

  function inflate_block(ll,dist){
    while(true){
      const sym=readSym(ll);
      if(sym<256){ out.push(sym); }
      else if(sym===256){ break; }
      else{
        const li=sym-257;
        const len=LBASE[li]+readBits(LEXT[li]);
        const di=readSym(dist);
        const dist2=DBASE[di]+readBits(DEXT[di]);
        const pos=out.length;
        for(let i=0;i<len;i++) out.push(out[pos-dist2+i]);
      }
    }
  }

  let final=0;
  while(!final){
    final=readBits(1);
    const type=readBits(2);
    if(type===0){
      // Stored block
      bits=0; bitbuf=0;
      const len=data[src]|(data[src+1]<<8); src+=4;
      for(let i=0;i<len;i++) out.push(data[src++]);
    } else if(type===1){
      const {ll,dist}=fixedTrees();
      inflate_block(ll,dist);
    } else if(type===2){
      const hlit=readBits(5)+257, hdist=readBits(5)+1, hclen=readBits(4)+4;
      const clenOrder=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];
      const clenLens=new Array(19).fill(0);
      for(let i=0;i<hclen;i++) clenLens[clenOrder[i]]=readBits(3);
      const clenTree=buildTree(clenLens);
      const lens=[];
      while(lens.length<hlit+hdist){
        const s=readSym(clenTree);
        if(s<16){ lens.push(s); }
        else if(s===16){ const rep=readBits(2)+3; for(let i=0;i<rep;i++) lens.push(lens[lens.length-1]); }
        else if(s===17){ const rep=readBits(3)+3; for(let i=0;i<rep;i++) lens.push(0); }
        else { const rep=readBits(7)+11; for(let i=0;i<rep;i++) lens.push(0); }
      }
      const ll=buildTree(lens.slice(0,hlit));
      const dist=buildTree(lens.slice(hlit));
      inflate_block(ll,dist);
    } else throw new Error('bad block type');
  }
  return new Uint8Array(out);
}

// â”€â”€â”€ Minimal ZIP reader (no external deps) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ZIP = {
  // Pure-JS DEFLATE inflate â€” works in all browsers including sandboxed contexts
  async inflate(data) {
    // Try native DecompressionStream first (fastest)
    if(typeof DecompressionStream !== 'undefined') {
      try {
        const ds = new DecompressionStream('deflate-raw');
        const chunks = [];
        const out = new WritableStream({ write(c){ chunks.push(c); } });
        const src = new ReadableStream({ start(c){ c.enqueue(data); c.close(); } });
        await src.pipeThrough(ds).pipeTo(out);
        const total = chunks.reduce((a,c)=>a+c.length,0);
        const result = new Uint8Array(total);
        let off=0; for(const c of chunks){ result.set(c,off); off+=c.length; }
        return result;
      } catch(e) { /* fall through to pure JS */ }
    }
    // Pure JS DEFLATE fallback
    return inflateRaw(data);
  },

  u32(buf,off){ return buf[off]|(buf[off+1]<<8)|(buf[off+2]<<16)|(buf[off+3]*16777216); },
  u16(buf,off){ return buf[off]|(buf[off+1]<<8); },

  async parse(arrayBuf) {
    const buf = new Uint8Array(arrayBuf);
    const files = {};
    // Find end of central directory
    let eocd = -1;
    for(let i=buf.length-22;i>=0;i--){
      if(buf[i]===0x50&&buf[i+1]===0x4B&&buf[i+2]===0x05&&buf[i+3]===0x06){ eocd=i; break; }
    }
    if(eocd<0) throw new Error('Not a valid ZIP file');
    const cdOffset = this.u32(buf, eocd+16);
    const cdSize   = this.u32(buf, eocd+12);
    let p = cdOffset;
    while(p < cdOffset+cdSize && p+46 < buf.length){
      if(buf[p]!==0x50||buf[p+1]!==0x4B||buf[p+2]!==0x01||buf[p+3]!==0x02) break;
      const method     = this.u16(buf,p+10);
      const compSize   = this.u32(buf,p+20);
      const uncompSize = this.u32(buf,p+24);
      const fnLen      = this.u16(buf,p+28);
      const extraLen   = this.u16(buf,p+30);
      const commentLen = this.u16(buf,p+32);
      const lhOffset   = this.u32(buf,p+42);
      const name = new TextDecoder().decode(buf.slice(p+46,p+46+fnLen));
      files[name] = { method, compSize, uncompSize, lhOffset };
      p += 46+fnLen+extraLen+commentLen;
    }
    // Read local file data
    const result = {};
    for(const [name,meta] of Object.entries(files)){
      const lh = meta.lhOffset;
      if(lh+30>buf.length) continue;
      const fnl = this.u16(buf,lh+26);
      const exl = this.u16(buf,lh+28);
      const dataStart = lh+30+fnl+exl;
      const raw = buf.slice(dataStart, dataStart+meta.compSize);
      result[name] = { method:meta.method, raw, uncompSize:meta.uncompSize };
    }
    return result;
  },

  async extractText(entry) {
    if(entry.method===0) return new TextDecoder().decode(entry.raw);
    const inflated = await this.inflate(entry.raw);
    return new TextDecoder().decode(inflated);
  },

  // Build ZIP for export (store method, no compression needed for our purposes)
  build(files) {
    // files: {name: Uint8Array|string}
    const enc = new TextEncoder();
    const entries = [];
    let offset = 0;
    const centralDir = [];

    for(const [name,data] of Object.entries(files)){
      const nameBytes = enc.encode(name);
      const content   = typeof data==='string' ? enc.encode(data) : data;
      // Local file header
      const lh = new Uint8Array(30+nameBytes.length+content.length);
      const dv = new DataView(lh.buffer);
      dv.setUint32(0,0x04034b50,true); // sig
      dv.setUint16(4,20,true);  // version needed
      dv.setUint16(6,0,true);   // flags
      dv.setUint16(8,0,true);   // method=store
      dv.setUint16(10,0,true);dv.setUint16(12,0,true); // mod time/date
      dv.setUint32(14,crc32(content),true);
      dv.setUint32(18,content.length,true);
      dv.setUint32(22,content.length,true);
      dv.setUint16(26,nameBytes.length,true);
      dv.setUint16(28,0,true);
      lh.set(nameBytes,30);
      lh.set(content,30+nameBytes.length);
      entries.push(lh);

      // Central directory entry
      const cd = new Uint8Array(46+nameBytes.length);
      const dv2 = new DataView(cd.buffer);
      dv2.setUint32(0,0x02014b50,true);
      dv2.setUint16(4,20,true);dv2.setUint16(6,20,true);
      dv2.setUint16(8,0,true);dv2.setUint16(10,0,true);
      dv2.setUint16(12,0,true);dv2.setUint16(14,0,true);
      dv2.setUint32(16,crc32(content),true);
      dv2.setUint32(20,content.length,true);
      dv2.setUint32(24,content.length,true);
      dv2.setUint16(28,nameBytes.length,true);
      dv2.setUint16(30,0,true);dv2.setUint16(32,0,true);
      dv2.setUint16(34,0,true);dv2.setUint16(36,0,true);
      dv2.setUint32(38,0,true);
      dv2.setUint32(42,offset,true);
      cd.set(nameBytes,46);
      centralDir.push(cd);
      offset += lh.length;
    }

    const cdData = concat(centralDir);
    const eocd = new Uint8Array(22);
    const dv3 = new DataView(eocd.buffer);
    dv3.setUint32(0,0x06054b50,true);
    dv3.setUint16(4,0,true);dv3.setUint16(6,0,true);
    dv3.setUint16(8,centralDir.length,true);
    dv3.setUint16(10,centralDir.length,true);
    dv3.setUint32(12,cdData.length,true);
    dv3.setUint32(16,offset,true);
    dv3.setUint16(20,0,true);
    return concat([...entries,cdData,eocd]);
  }
};

function concat(arrays){
  const total=arrays.reduce((a,c)=>a+c.length,0);
  const out=new Uint8Array(total);
  let off=0;for(const a of arrays){out.set(a,off);off+=a.length;}
  return out;
}

// CRC32
const crcTable=(()=>{const t=new Uint32Array(256);for(let i=0;i<256;i++){let c=i;for(let j=0;j<8;j++)c=c&1?(0xEDB88320^(c>>>1)):(c>>>1);t[i]=c;}return t;})();
function crc32(data){let c=0xFFFFFFFF;for(const b of data)c=crcTable[(c^b)&0xFF]^(c>>>8);return(c^0xFFFFFFFF)>>>0;}

// â”€â”€â”€ App state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ls={
  get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}},
  set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}}
};

let theme    = ls.get('3f-theme','dark');
let printers = ls.get('3f-printers',[]);
let suppShown= ls.get('3f-sup',false);
let btnLabels= ls.get('3f-btnlabels',false);
let lang     = ls.get('3f-lang','en');

// â”€â”€â”€ UI string translations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TR={
  en:{
    step1:'File Selection', step2:'Options & Process', step3:'Export',
    chooseFile:'Choose 3MF File', fileLoaded:'âœ” File Loaded', dragDrop:'or drag & drop a .3mf file onto the phone',
    dropHere:'Drop .3mf here â†“', ready:'Ready for file selection', waiting:'Waitingâ€¦',
    changePrinter:'Change Printer Data', removePrinter:'Remove Printer Data',
    removeFilament:'Remove Filament Data', removeProcess:'Remove Process Data', removeAll:'Remove All Data',
    outputName:'Output file name', process:'Process', report:'Report', reset:'Reset', restore:'Restore',
    exportBtn:'Export 3MF', settings:'Settings', btnLabels:'Button Labels',
    theme:'Theme', dark:'Dark', light:'Light', system:'System',
    language:'Language', printerConfig:'Printer Configurations', more:'More',
    faq:'FAQ', about:'About', help:'Help', contact:'Get in Touch',
    close:'Close', save:'Save Printer', skip:'Skip',
    savePrinterQ:'Save Printer?', savePrinterPrompt:'Would you like to save this printer configuration?',
    setDefault:'Set as default printer', firstNote:'This will be your first printer and will be set as default automatically.',
    noPrinters:'No printers saved yet. Load a 3MF file to detect and save printer settings.',
    supportDev:'Support Development', supportBody:"3MFix is built by one person. If it's been useful, a coffee helps keep it free.",
    buyCoffee:'Buy Me a Coffee â˜•', maybeLater:'Maybe later',
    useDefault:'Use Default', noPrintersSaved:'No printers saved',
    display:'Display',
  },
  es:{
    step1:'SelecciÃ³n de archivo', step2:'Opciones y proceso', step3:'Exportar',
    chooseFile:'Elegir archivo 3MF', fileLoaded:'âœ” Archivo cargado', dragDrop:'o arrastra y suelta un archivo .3mf aquÃ­',
    dropHere:'Suelta el .3mf aquÃ­ â†“', ready:'Listo para seleccionar archivo', waiting:'Esperandoâ€¦',
    changePrinter:'Cambiar datos de impresora', removePrinter:'Eliminar datos de impresora',
    removeFilament:'Eliminar datos de filamento', removeProcess:'Eliminar datos de proceso', removeAll:'Eliminar todos los datos',
    outputName:'Nombre del archivo de salida', process:'Procesar', report:'Informe', reset:'Reiniciar', restore:'Restaurar',
    exportBtn:'Exportar 3MF', settings:'Ajustes', btnLabels:'Etiquetas de botones',
    theme:'Tema', dark:'Oscuro', light:'Claro', system:'Sistema',
    language:'Idioma', printerConfig:'Configuraciones de impresora', more:'MÃ¡s',
    faq:'Preguntas frecuentes', about:'Acerca de', help:'Ayuda', contact:'Contacto',
    close:'Cerrar', save:'Guardar impresora', skip:'Omitir',
    savePrinterQ:'Â¿Guardar impresora?', savePrinterPrompt:'Â¿Deseas guardar esta configuraciÃ³n de impresora?',
    setDefault:'Establecer como impresora predeterminada', firstNote:'Esta serÃ¡ tu primera impresora y se establecerÃ¡ como predeterminada automÃ¡ticamente.',
    noPrinters:'AÃºn no hay impresoras guardadas. Carga un archivo 3MF para detectar y guardar la configuraciÃ³n.',
    supportDev:'Apoyar el desarrollo', supportBody:'3MFix es desarrollado por una sola persona. Si te ha sido Ãºtil, un cafÃ© ayuda a mantenerlo gratuito.',
    buyCoffee:'InvÃ­tame un cafÃ© â˜•', maybeLater:'QuizÃ¡s despuÃ©s',
    useDefault:'Usar predeterminada', noPrintersSaved:'No hay impresoras guardadas',
    display:'Pantalla',
  },
  fr:{
    step1:'SÃ©lection du fichier', step2:'Options et traitement', step3:'Exporter',
    chooseFile:'Choisir un fichier 3MF', fileLoaded:'âœ” Fichier chargÃ©', dragDrop:'ou glissez-dÃ©posez un fichier .3mf ici',
    dropHere:'DÃ©posez le .3mf ici â†“', ready:'PrÃªt pour la sÃ©lection du fichier', waiting:'En attenteâ€¦',
    changePrinter:"Modifier les donnÃ©es de l'imprimante", removePrinter:"Supprimer les donnÃ©es de l'imprimante",
    removeFilament:'Supprimer les donnÃ©es du filament', removeProcess:"Supprimer les donnÃ©es du processus", removeAll:'Supprimer toutes les donnÃ©es',
    outputName:'Nom du fichier de sortie', process:'Traiter', report:'Rapport', reset:'RÃ©initialiser', restore:'Restaurer',
    exportBtn:'Exporter 3MF', settings:'ParamÃ¨tres', btnLabels:'Ã‰tiquettes des boutons',
    theme:'ThÃ¨me', dark:'Sombre', light:'Clair', system:'SystÃ¨me',
    language:'Langue', printerConfig:"Configurations d'imprimante", more:'Plus',
    faq:'FAQ', about:'Ã€ propos', help:'Aide', contact:'Nous contacter',
    close:'Fermer', save:"Enregistrer l'imprimante", skip:'Ignorer',
    savePrinterQ:"Enregistrer l'imprimante ?", savePrinterPrompt:"Souhaitez-vous enregistrer cette configuration d'imprimante ?",
    setDefault:"DÃ©finir comme imprimante par dÃ©faut", firstNote:"Ce sera votre premiÃ¨re imprimante et elle sera dÃ©finie par dÃ©faut automatiquement.",
    noPrinters:"Aucune imprimante enregistrÃ©e. Chargez un fichier 3MF pour dÃ©tecter et enregistrer la configuration.",
    supportDev:'Soutenir le dÃ©veloppement', supportBody:"3MFix est dÃ©veloppÃ© par une seule personne. Si l'application vous a Ã©tÃ© utile, un cafÃ© aide Ã  la maintenir gratuite.",
    buyCoffee:'Offrez-moi un cafÃ© â˜•', maybeLater:'Peut-Ãªtre plus tard',
    useDefault:'Utiliser la dÃ©faut', noPrintersSaved:"Aucune imprimante enregistrÃ©e",
    display:'Affichage',
  },
  de:{
    step1:'Dateiauswahl', step2:'Optionen und Verarbeitung', step3:'Exportieren',
    chooseFile:'3MF-Datei auswÃ¤hlen', fileLoaded:'âœ” Datei geladen', dragDrop:'oder eine .3mf-Datei hierher ziehen',
    dropHere:'.3mf hier ablegen â†“', ready:'Bereit zur Dateiauswahl', waiting:'Wartenâ€¦',
    changePrinter:'Druckerdaten Ã¤ndern', removePrinter:'Druckerdaten entfernen',
    removeFilament:'Filamentdaten entfernen', removeProcess:'Prozessdaten entfernen', removeAll:'Alle Daten entfernen',
    outputName:'Name der Ausgabedatei', process:'Verarbeiten', report:'Bericht', reset:'ZurÃ¼cksetzen', restore:'Wiederherstellen',
    exportBtn:'3MF exportieren', settings:'Einstellungen', btnLabels:'SchaltflÃ¤chenbeschriftungen',
    theme:'Design', dark:'Dunkel', light:'Hell', system:'System',
    language:'Sprache', printerConfig:'Druckerkonfigurationen', more:'Mehr',
    faq:'FAQ', about:'Ãœber', help:'Hilfe', contact:'Kontakt',
    close:'SchlieÃŸen', save:'Drucker speichern', skip:'Ãœberspringen',
    savePrinterQ:'Drucker speichern?', savePrinterPrompt:'MÃ¶chten Sie diese Druckerkonfiguration speichern?',
    setDefault:'Als Standarddrucker festlegen', firstNote:'Dies wird Ihr erster Drucker und wird automatisch als Standard festgelegt.',
    noPrinters:'Noch keine Drucker gespeichert. Laden Sie eine 3MF-Datei, um die Druckerkonfiguration zu erkennen.',
    supportDev:'Entwicklung unterstÃ¼tzen', supportBody:'3MFix wird von einer einzelnen Person entwickelt. Wenn die App nÃ¼tzlich war, hilft ein Kaffee dabei, sie kostenlos zu halten.',
    buyCoffee:'Kauf mir einen Kaffee â˜•', maybeLater:'Vielleicht spÃ¤ter',
    useDefault:'Standard verwenden', noPrintersSaved:'Keine Drucker gespeichert',
    display:'Anzeige',
  }
};
function t(k){return (TR[lang]||TR.en)[k]||TR.en[k]||k;}

function applyLang(){
  // Update static UI text that's always visible (cards, buttons, hints)
  const u=(id,k)=>{const el=document.getElementById(id);if(el)el.textContent=t(k);};
  const uh=(id,k)=>{const el=document.getElementById(id);if(el)el.innerHTML=t(k);};
  // Card titles
  const titles=document.querySelectorAll('.ctitle');
  if(titles[0])titles[0].textContent=t('step1');
  if(titles[1])titles[1].textContent=t('step2');
  if(titles[2])titles[2].textContent=t('step3');
  // Buttons
  const cb=document.getElementById('chooseBtn');
  if(cb&&!cb.classList.contains('bloaded'))cb.textContent=t('chooseFile');
  u('dhint','dragDrop');
  const xb=document.getElementById('exportBtn');
  if(xb)xb.textContent=t('exportBtn');
  document.getElementById('outName').placeholder=t('outputName');
  // Toggle labels
  const tlbls=document.querySelectorAll('.tlbl');
  const tkmap=['changePrinter','removePrinter','removeFilament','removeProcess','removeAll'];
  tlbls.forEach((el,i)=>{if(tkmap[i])el.textContent=t(tkmap[i]);});
  // Icon button labels
  const ilbls={process:'process',report:'report',reset:'reset',restore:'restore'};
  for(const[id,k] of Object.entries(ilbls)){const el=document.getElementById('lbl-'+id);if(el)el.textContent=t(k);}
  // Printer select default option
  renderPSel();
  document.documentElement.lang=lang;
}

let rawJson=null, configPath=null, parsedZip=null, origBytes=null;
let extracted=null, backupRaw=null;
let step1Locked=false;

let opts = {cp:false,rp:false,rf:false,rc:false,ra:false};
let dis  = {cp:false,rp:false,rf:true, rc:true, ra:false};

let pendingPrinter=null, setAsDef=false, fitWarn=null;

// â”€â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTheme(){
  const r=theme==='system'?(window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'):theme;
  document.body.classList.toggle('light',r==='light');
  ls.set('3f-theme',theme);
}
applyTheme();

function applyBtnLabels(){
  ['process','report','reset','restore'].forEach(id=>{
    const el=document.getElementById('lbl-'+id);
    if(el) el.style.display=btnLabels?'':'none';
  });
  ls.set('3f-btnlabels',btnLabels);
}
applyBtnLabels();
applyLang();

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isPK(k){
  return ['printer_','machine_','nozzle_','extruder_','bed_','host_'].some(p=>k.startsWith(p))
    ||['curr_bed_type','printable_area','printable_height','gcode_flavor','upward_compatible_machine'].includes(k);
}
function getNozzle(s){const n=s?.nozzle_diameter;if(Array.isArray(n)&&n.length)return String(n[0]);return n!=null?String(n):null;}
function nozzDisp(s){const n=getNozzle(s);return n?n+'mm':'Unknown';}
function icon(t){return t==='s'?'âœ”':t==='e'?'âœ–':t==='w'?'âš ':'Â·';}
function logEl(t,m){const d=document.createElement('div');d.className='l'+t;d.textContent=icon(t)+' '+m;return d;}
function setLog(id,arr){const el=document.getElementById(id);el.innerHTML='';arr.forEach(e=>el.appendChild(logEl(e.t,e.m)));}
function addLog(id,t,m){document.getElementById(id).appendChild(logEl(t,m));}
function setProgress(p){document.getElementById('pfill').style.width=p+'%';}
function lock(id,v){const c=document.getElementById(id);c.classList.toggle('locked',v);}

// â”€â”€â”€ Toggle render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const togMap={cp:'t-cp',rp:'t-rp',rf:'t-rf',rc:'t-rc',ra:'t-ra'};
const trkMap={cp:'tk-cp',rp:'tk-rp',rf:'tk-rf',rc:'tk-rc',ra:'tk-ra'};

function renderToggles(){
  for(const[k]of Object.entries(opts)){
    document.getElementById(togMap[k]).classList.toggle('dis',dis[k]);
    document.getElementById(trkMap[k]).classList.toggle('on',opts[k]);
  }
  document.getElementById('pindent').style.display=opts.cp?'block':'none';
  document.getElementById('processBtn').disabled=!Object.values(opts).some(v=>v);
}

function toggleOpt(key){
  let{cp,rp,rf,rc,ra}=opts;
  switch(key){
    case'cp':cp=!cp;if(cp){rp=false;ra=false;}break;
    case'rp':rp=!rp;if(rp){cp=false;ra=false;}break;
    case'rf':rf=!rf;if(!rf)ra=false;break;
    case'rc':rc=!rc;if(!rc)ra=false;break;
    case'ra':ra=!ra;if(ra){cp=false;rp=true;rf=!dis.rf;rc=!dis.rc;}else{rp=false;rf=false;rc=false;}break;
  }
  if(rp&&rf&&rc)ra=true;
  opts={cp,rp,rf,rc,ra};
  renderToggles();
}

document.querySelectorAll('.trow[data-key]').forEach(r=>{
  r.addEventListener('click',()=>{
    const m={changePrinter:'cp',removePrinter:'rp',removeFilament:'rf',removeProcess:'rc',removeAll:'ra'};
    toggleOpt(m[r.dataset.key]);
  });
});

// â”€â”€â”€ Printer select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPSel(){
  const sel=document.getElementById('psel');
  const def=printers.find(p=>p.isDefault)||printers[0];
  sel.innerHTML='';
  const o=document.createElement('option');o.value='default';
  o.textContent=printers.length?`${t('useDefault')} (${def?.printerModel||''})` :t('noPrintersSaved');
  sel.appendChild(o);
  printers.filter(p=>!p.isDefault).forEach(p=>{const o2=document.createElement('option');o2.value=p.printerModel;o2.textContent=p.printerModel;sel.appendChild(o2);});
}

// â”€â”€â”€ File load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleFile(file){
  if(!file.name.toLowerCase().endsWith('.3mf')){
    setLog('con1',[{t:'e',m:`Invalid file: "${file.name}"`},{t:'w',m:'Only .3mf files supported'}]);return;
  }
  if(!file.size){setLog('con1',[{t:'e',m:'File is empty'}]);return;}
  if(file.size>500*1024*1024){setLog('con1',[{t:'e',m:`Too large: ${(file.size/1024/1024).toFixed(1)} MB`},{t:'w',m:'Max 500 MB'}]);return;}

  const sz=(file.size/1024/1024).toFixed(2);
  setLog('con1',[{t:'s',m:`Selected: ${file.name}`},{t:'i',m:`Size: ${sz} MB`},{t:'i',m:'Parsing ZIPâ€¦'}]);

  try{
    origBytes = await file.arrayBuffer();
    parsedZip = await ZIP.parse(origBytes);

    const keys=Object.keys(parsedZip);
    addLog('con1','i',`Found ${keys.length} files in archive`);

    // Find config
    const cands=['Metadata/project_settings.config','metadata/project_settings.config','project_settings.config'];
    configPath=null;
    for(const c of cands){if(parsedZip[c]){configPath=c;break;}}

    if(configPath) addLog('con1','s',`Found: ${configPath}`);
    else addLog('con1','w','No project_settings.config found');

    let ps=null;
    if(configPath){
      rawJson=await ZIP.extractText(parsedZip[configPath]);
      try{ps=JSON.parse(rawJson);}catch{addLog('con1','w','Could not parse config JSON');}
      if(ps) addLog('con1','s','Config parsed successfully');
    }

    const printerS={},filamentS={},processS={};
    if(ps){
      for(const[k,v]of Object.entries(ps)){
        if(isPK(k))printerS[k]=v;
        else if(k.startsWith('filament_'))filamentS[k]=v;
        else processS[k]=v;
      }
    }

    addLog('con1','i','Scanning printer dataâ€¦');
    const model=printerS.printer_model||'Unknown';
    addLog('con1','s',`Printer: ${model}`);
    addLog('con1','i',`Printer fields: ${Object.keys(printerS).length}`);
    addLog('con1','i',`Filament fields: ${Object.keys(filamentS).length}`);
    addLog('con1','i',`Process fields: ${Object.keys(processS).length}`);
    addLog('con1','s','Scan complete');

    // â”€â”€ Detect if this file was already processed by 3MFix (has a backup entry)
    const backupPath = configPath ? configPath+'.backup' : null;
    const hasExistingBackup = !!(backupPath && parsedZip[backupPath]);
    if(hasExistingBackup){
      backupRaw = await ZIP.extractText(parsedZip[backupPath]);
      addLog('con1','w','Previously modified by 3MFix â€” restore required before re-processing');
    } else {
      backupRaw = null;
    }

    // â”€â”€ Parse bounding box from .model geometry (only needed for Change Printer fit check)
    let modelBBox = null;
    const modelEntry = Object.entries(parsedZip).find(([n])=>n.endsWith('.model')&&!n.includes('thumbnail'));
    if(modelEntry){
      try{
        addLog('con1','i','Reading model geometryâ€¦');
        const modelXml = await ZIP.extractText(modelEntry[1]);
        modelBBox = calcBoundingBox(modelXml);
        if(modelBBox) addLog('con1','i',`Model size: ${modelBBox.x.toFixed(1)}Ã—${modelBBox.y.toFixed(1)}Ã—${modelBBox.z.toFixed(1)} mm`);
      }catch(e){ /* non-fatal */ }
    }

    extracted={
      printerSettings:Object.keys(printerS).length?printerS:null,
      filamentSettings:Object.keys(filamentS).length?filamentS:null,
      processSettings:Object.keys(processS).length?processS:null,
      modelBoundingBox:modelBBox
    };
    step1Locked=true;

    lock('card1',true); lock('card2',false); lock('card3',true);
    setLog('con2',[{t:'i',m:'Waitingâ€¦'}]); setProgress(0);
    opts={cp:false,rp:false,rf:false,rc:false,ra:false};
    const currentNozzle=getNozzle(printerS);
    // Change Printer enabled when: 2+ printers exist, OR 1 printer exists but differs from current file
    const cpEnabled = printers.length>=2
      || (printers.length===1 && (printers[0].printerModel!==model || getNozzle(printers[0].settings)!==currentNozzle));
    dis={
      cp: !cpEnabled,
      rp:false,
      rf:Object.keys(filamentS).length===0,
      rc:Object.keys(processS).length===0,
      ra:false
    };

    // â”€â”€ If already modified: lock all options, only allow Restore
    if(hasExistingBackup){
      dis={cp:true,rp:true,rf:true,rc:true,ra:true};
      document.getElementById('restoreBtn').disabled=false;
      setLog('con2',[
        {t:'w',m:'This file has already been processed by 3MFix.'},
        {t:'w',m:'Tap âŸ³ Restore to reset it before making new changes.'}
      ]);
    } else {
      document.getElementById('restoreBtn').disabled=true;
    }

    document.getElementById('outName').value=`3MFix_${file.name.replace(/\.3mf$/i,'')}`;
    const btn=document.getElementById('chooseBtn');
    btn.textContent='âœ” File Loaded'; btn.className='btn bloaded';
    document.getElementById('dhint').style.display='none';
    renderToggles(); renderPSel();

    // New printer check (model + nozzle) â€” skip if already modified
    if(!hasExistingBackup){
      const nozzle=getNozzle(printerS);
      const isNew=Object.keys(printerS).length>0
        &&!printers.some(p=>p.printerModel===model&&getNozzle(p.settings)===nozzle);
      if(isNew){pendingPrinter=printerS;setAsDef=printers.length===0;showModal('save-printer');}
    }

  }catch(err){
    addLog('con1','e',`Error: ${err.message}`);
    addLog('con1','w','Ensure this is a valid .3mf slicer export');
  }
}

// â”€â”€â”€ Drag & drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const scr=document.getElementById('screen');
const dz=document.getElementById('dz');
scr.addEventListener('dragenter',e=>{e.preventDefault();e.stopPropagation();});
scr.addEventListener('dragover',e=>{
  e.preventDefault();e.stopPropagation();dz.classList.add('active');
  if(!step1Locked)document.getElementById('chooseBtn').textContent='Drop .3mf here â†“';
});
scr.addEventListener('dragleave',e=>{
  e.stopPropagation();
  if(!scr.contains(e.relatedTarget)){
    dz.classList.remove('active');
    if(!step1Locked)document.getElementById('chooseBtn').textContent='Choose 3MF File';
  }
});
scr.addEventListener('drop',e=>{
  e.preventDefault();e.stopPropagation();dz.classList.remove('active');
  if(!step1Locked)document.getElementById('chooseBtn').textContent='Choose 3MF File';
  const f=e.dataTransfer.files[0];if(f)handleFile(f);
});
document.getElementById('chooseBtn').addEventListener('click',()=>{if(!step1Locked)document.getElementById('fileInput').click();});
document.getElementById('fileInput').addEventListener('change',function(){if(this.files[0])handleFile(this.files[0]);});

// â”€â”€â”€ Process â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function processFile(skipFit){
  if(!rawJson){setLog('con2',[{t:'e',m:'No file loaded'}]);return;}
  setLog('con2',[{t:'i',m:'Processingâ€¦'}]);setProgress(10);
  try{
    let mod=JSON.parse(rawJson);

    if(opts.ra){
      addLog('con2','i','Removing all dataâ€¦');
      for(const k of Object.keys(mod))delete mod[k];
    } else {
      if(opts.cp){
        addLog('con2','i','Applying printer configâ€¦');
        const selVal=document.getElementById('psel').value;
        const target=selVal==='default'?(printers.find(p=>p.isDefault)||printers[0]):printers.find(p=>p.printerModel===selVal)||printers[0];
        if(target){
          if(!skipFit&&extracted?.printerSettings){
            const fw=checkFit(extracted,target);
            if(fw){fitWarn=fw;setProgress(0);showModal('fit-warning');return;}
          }
          Object.assign(mod,target.settings);
          addLog('con2','s',`Injected: ${target.printerModel}`);
        }
      }
      if(opts.rp){addLog('con2','i','Removing printer dataâ€¦');for(const k of Object.keys(mod))if(isPK(k))delete mod[k];}
      if(opts.rf){addLog('con2','i','Removing filament dataâ€¦');for(const k of Object.keys(mod))if(k.startsWith('filament_'))delete mod[k];}
      if(opts.rc){addLog('con2','i','Removing process dataâ€¦');for(const k of Object.keys(mod))if(!isPK(k)&&!k.startsWith('filament_'))delete mod[k];}
    }

    const newCfg=JSON.stringify(mod);
    // Store backup on first process
    if(!backupRaw)backupRaw=rawJson;

    // Rebuild ZIP with updated config (preserve all original files, update config)
    const outFiles={};
    for(const[name,entry]of Object.entries(parsedZip)){
      if(name===configPath)continue; // will replace below
      const isStored=entry.method===0;
      outFiles[name]=isStored?entry.raw:await ZIP.inflate(entry.raw).catch(()=>entry.raw);
    }
    if(configPath){
      outFiles[configPath]=newCfg;
      // Embed backup
      const bkPath=configPath+'.backup';
      if(!outFiles[bkPath])outFiles[bkPath]=backupRaw;
    }
    const newZip=ZIP.build(outFiles);
    // Store as new parsedZip for chaining
    origBytes=newZip.buffer;
    parsedZip=await ZIP.parse(origBytes);
    rawJson=newCfg;

    addLog('con2','s','Config updated');
    addLog('con2','s','Processing complete');
    setProgress(100);
    lock('card3',false);
    document.getElementById('restoreBtn').disabled=false;
  }catch(err){
    setLog('con2',[{t:'e',m:`Error: ${err.message}`},{t:'w',m:'Try resetting and reloading'}]);
    setProgress(0);
  }
}

// â”€â”€â”€ Restore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function restoreFile(){
  if(!backupRaw)return;
  try{
    const outFiles={};
    for(const[name,entry]of Object.entries(parsedZip)){
      if(name===configPath||name===configPath+'.backup')continue;
      const isStored=entry.method===0;
      outFiles[name]=isStored?entry.raw:await ZIP.inflate(entry.raw).catch(()=>entry.raw);
    }
    if(configPath)outFiles[configPath]=backupRaw;
    const newZip=ZIP.build(outFiles);
    origBytes=newZip.buffer;
    parsedZip=await ZIP.parse(origBytes);
    rawJson=backupRaw; backupRaw=null;
    setProgress(0); lock('card3',true);
    addLog('con1','s','Restored from backup');
    setLog('con2',[{t:'i',m:'Waitingâ€¦'}]);
    document.getElementById('restoreBtn').disabled=true;
    // Re-enable options now that restore is done
    const restoredPs=extracted?.printerSettings||{};
    const restoredModel=restoredPs.printer_model||'Unknown';
    const restoredNozzle=getNozzle(restoredPs);
    const cpOk=printers.length>=2||(printers.length===1&&(printers[0].printerModel!==restoredModel||getNozzle(printers[0].settings)!==restoredNozzle));
    dis={
      cp:!cpOk,
      rp:false,
      rf:!extracted?.filamentSettings,
      rc:!extracted?.processSettings,
      ra:false
    };
    opts={cp:false,rp:false,rf:false,rc:false,ra:false};
    renderToggles();
  }catch(err){addLog('con1','e',`Restore error: ${err.message}`);}
}

// â”€â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportFile(){
  if(!origBytes){addLog('con2','e','No processed file');return;}
  let name=document.getElementById('outName').value.trim();
  if(!name){addLog('con2','e','Enter an output file name');return;}
  if(!name.endsWith('.3mf'))name+='.3mf';
  const blob=new Blob([origBytes],{type:'application/octet-stream'});

  // Detect any Apple touch device (covers iPhone, iPad, iPod)
  const isApple='ontouchstart' in window && /Apple/.test(navigator.vendor);

  // Web Share API: works on iOS Safari when called synchronously from a tap.
  // Try it for any device that supports file sharing â€” not just Apple.
  if(navigator.canShare && navigator.share){
    const file=new File([blob],name,{type:'application/octet-stream'});
    try{
      if(navigator.canShare({files:[file]})){
        // Must call share() synchronously â€” no await before this line
        navigator.share({files:[file],title:name,text:name}).then(()=>{
          addLog('con2','s','Shared successfully');
          setTimeout(()=>{if(!suppShown)showModal('support');else resetApp();},1500);
        }).catch(err=>{
          if(err.name!=='AbortError'){
            addLog('con2','w','Share dismissed â€” trying downloadâ€¦');
            doDownload(blob,name);
          }
        });
        return;
      }
    }catch(e){}
  }

  // Fallback: standard download (Android Chrome, desktop)
  doDownload(blob,name);
}

function doDownload(blob,name){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),2000);
  addLog('con2','s',`Exported: ${name}`);
  setTimeout(()=>{if(!suppShown)showModal('support');else resetApp();},1500);
}

// â”€â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetApp(){
  step1Locked=false;
  lock('card1',false);lock('card2',true);lock('card3',true);
  setLog('con1',[{t:'s',m:'Ready for file selection'}]);
  setLog('con2',[{t:'i',m:'Waitingâ€¦'}]);
  setProgress(0);
  rawJson=null;configPath=null;parsedZip=null;origBytes=null;extracted=null;backupRaw=null;fitWarn=null;
  opts={cp:false,rp:false,rf:false,rc:false,ra:false};
  dis={cp:false,rp:false,rf:true,rc:true,ra:false};
  document.getElementById('outName').value='';
  const btn=document.getElementById('chooseBtn');btn.textContent='Choose 3MF File';btn.className='btn bpri';
  document.getElementById('dhint').style.display='';
  document.getElementById('fileInput').value='';
  document.getElementById('restoreBtn').disabled=true;
  document.getElementById('processBtn').disabled=true;
  renderToggles();
}

// â”€â”€â”€ Bounding box from .model XML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcBoundingBox(xmlStr){
  // Extract all vertex coordinates from <vertex x="..." y="..." z="..."/>
  let minX=Infinity,minY=Infinity,minZ=Infinity;
  let maxX=-Infinity,maxY=-Infinity,maxZ=-Infinity;
  const re=/\bx="([^"]+)"[^>]*\by="([^"]+)"[^>]*\bz="([^"]+)"/g;
  let m, count=0;
  while((m=re.exec(xmlStr))!==null){
    const x=parseFloat(m[1]),y=parseFloat(m[2]),z=parseFloat(m[3]);
    if(isNaN(x)||isNaN(y)||isNaN(z))continue;
    if(x<minX)minX=x;if(x>maxX)maxX=x;
    if(y<minY)minY=y;if(y>maxY)maxY=y;
    if(z<minZ)minZ=z;if(z>maxZ)maxZ=z;
    count++;
  }
  if(count<2)return null;
  return{x:maxX-minX, y:maxY-minY, z:maxZ-minZ};
}

// â”€â”€â”€ Fit check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkFit(ext,printer){
  try{
    const bbox=ext.modelBoundingBox;if(!bbox)return null;
    const aR=printer.settings.printable_area,hR=printer.settings.printable_height;
    if(!aR||!hR)return null;
    const area=typeof aR==='string'?JSON.parse(aR):aR;
    const xs=area.map(p=>parseFloat(p[0])),ys=area.map(p=>parseFloat(p[1]));
    const bX=Math.max(...xs)-Math.min(...xs),bY=Math.max(...ys)-Math.min(...ys),bZ=parseFloat(hR);
    const eX=bbox.x>bX,eY=bbox.y>bY,eZ=bbox.z>bZ;
    if(eX||eY||eZ)return{modelSize:bbox,bed:{x:bX,y:bY,z:bZ},exceeds:{x:eX,y:eY,z:eZ},name:printer.printerModel};
  }catch{}return null;
}

// â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function $(id){return document.getElementById(id);}
function cbtn(label){return `<button class="btn bpri" style="width:140px" onclick="closeModal()">${label}</button>`;}

function showModal(which){
  const ov=$('overlay'),ttl=$('mttl'),body=$('mbody'),ftr=$('mftr');
  body.innerHTML='';ftr.innerHTML='';ftr.style.display='';

  if(which==='settings'){
    ttl.textContent=t('settings');
    body.innerHTML=`
      <div class="slabel">${t('theme')}</div>
      <div class="trow2">
        ${[{m:'dark',i:'ðŸŒ™',lk:'dark'},{m:'light',i:'â˜€ï¸',lk:'light'},{m:'system',i:'âš¡',lk:'system'}].map(o=>`<div class="topt${theme===o.m?' on':''}" onclick="setTheme('${o.m}')">${o.i}<br>${t(o.lk)}</div>`).join('')}
      </div>
      <div class="slabel">${t('display')}</div>
      <div class="trow" style="border-bottom:none;cursor:pointer" onclick="toggleBtnLabels()">
        <span class="tlbl">${t('btnLabels')}</span>
        <div class="ttrack${btnLabels?' on':''}" id="lbltrk"><div class="tknob"></div></div>
      </div>
      <div class="slabel">${t('language')}</div>
      <select class="gsel" onchange="setLang(this.value)">
        ${[['en','ðŸ‡ºðŸ‡¸ English'],['es','ðŸ‡ªðŸ‡¸ EspaÃ±ol'],['fr','ðŸ‡«ðŸ‡· FranÃ§ais'],['de','ðŸ‡©ðŸ‡ª Deutsch']].map(([c,l])=>`<option value="${c}"${lang===c?' selected':''}>${l}</option>`).join('')}
      </select>
      <div class="slabel">${t('printerConfig')}</div>
      <div id="plistel">${renderPList()}</div>
      <div class="slabel" style="margin-bottom:12px">${t('more')}</div>
      <div class="mitem" onclick="showModal('faq')">â“&nbsp; ${t('faq')}</div>
      <div class="mitem" onclick="showModal('about')">â„¹ï¸&nbsp; ${t('about')}</div>
      <div class="mitem" onclick="showModal('help')">ðŸ”§&nbsp; ${t('help')}</div>
      <div class="mitem" onclick="showModal('contact')">âœ‰ï¸&nbsp; ${t('contact')}</div>
      <div class="supcard">
        <div class="supttl">${t('supportDev')}</div>
        <div class="supbody">${t('supportBody')}</div>
        <button class="btn borg" onclick="window.open('https://ko-fi.com/3MFix','_blank')">${t('buyCoffee')}</button>
      </div>`;
    ftr.innerHTML=cbtn(t('close'));
  }

  else if(which==='save-printer'&&pendingPrinter){
    const model=pendingPrinter.printer_model||'Unknown';
    ttl.textContent=t('savePrinterQ');
    body.innerHTML=`
      <p class="btxt" style="margin-bottom:16px">${t('savePrinterPrompt')}</p>
      <div class="spcard">
        <div class="spmodel">${model}</div>
        <div class="spsub">Nozzle: ${nozzDisp(pendingPrinter)} Â· Bed: ${pendingPrinter.curr_bed_type||'Unknown'}</div>
      </div>
      <div class="tinline" onclick="toggleDef()">
        <div class="ttrack${setAsDef?' on':''}" id="deftrk"><div class="tknob"></div></div>
        <span class="tinlinelbl">${t('setDefault')}</span>
      </div>
      ${printers.length===0?`<p class="firstnote">${t('firstNote')}</p>`:''}`;
    ftr.innerHTML=`
      <button class="btn bpri" style="width:150px" onclick="savePrinter()">${t('save')}</button>
      <button class="btn bred" style="width:100px" onclick="skipSave()">${t('skip')}</button>`;
  }

  else if(which==='fit-warning'&&fitWarn){
    const fw=fitWarn;
    ttl.innerHTML='<span style="color:#FFAA00">âš ï¸ Model May Not Fit</span>';
    body.innerHTML=`
      <p class="btxt">The model exceeds the build volume of the selected printer.</p>
      <p style="color:#9AA2B5;font-size:12px;margin:12px 0">Printer: <strong style="color:#fff">${fw.name}</strong></p>
      <table class="ftbl">
        <thead><tr><th></th><th>Model mm</th><th>Bed mm</th><th>Over?</th></tr></thead>
        <tbody>${['x','y','z'].map(a=>`<tr><td>${a.toUpperCase()}</td><td class="${fw.exceeds[a]?'fexc':''}">${fw.modelSize[a]?.toFixed(1)||'?'}</td><td>${fw.bed[a]?.toFixed(1)||'?'}</td><td class="${fw.exceeds[a]?'fexc':''}">${fw.exceeds[a]?'YES':'â€”'}</td></tr>`).join('')}</tbody>
      </table>`;
    ftr.innerHTML=`
      <button class="btn bpri" style="flex:1" onclick="closeModal();fitWarn=null;processFile(true)">Proceed Anyway</button>
      <button class="btn bred" style="flex:1" onclick="closeModal();fitWarn=null">Cancel</button>`;
  }

  else if(which==='report'){
    ttl.textContent='Extraction Report';
    const ps=extracted?.printerSettings,fs=extracted?.filamentSettings,prs=extracted?.processSettings;
    const row=(l,v)=>`<div class="rrow"><span class="rk">${l}:</span><span class="rv${v?'':' miss'}">${v||'NOT FOUND'}</span></div>`;
    if(!ps){body.innerHTML=`<p style="color:#9AA2B5">No data extracted yet. Load a 3MF file first.</p>`;}
    else body.innerHTML=`
      <div class="rsec">PRINTER DATA</div>
      ${row('Model',ps.printer_model)}${row('Nozzle',nozzDisp(ps))}${row('Bed Type',ps.curr_bed_type)}${row('G-code',ps.gcode_flavor)}${row('Start G-code',ps.machine_start_gcode?ps.machine_start_gcode.length+' chars':null)}
      <div class="rbadge">Total: ${Object.keys(ps).length} fields</div>
      ${fs?`<div class="rsec" style="margin-top:20px">FILAMENT DATA</div>${row('Type',fs.filament_type?.toString())}${row('Color',fs.filament_colour?.toString())}${row('Vendor',fs.filament_vendor?.toString())}${row('Diameter',fs.filament_diameter?.toString())}<div class="rbadge">Total: ${Object.keys(fs).length} fields</div>`:''}
      ${prs&&Object.keys(prs).length?`<div class="rsec" style="margin-top:20px">PROCESS DATA</div>${row('Layer Height',prs.layer_height?.toString())}${row('Line Width',prs.line_width?.toString())}${row('Infill',prs.sparse_infill_density?.toString())}${row('Wall Loops',prs.wall_loops?.toString())}${Object.keys(prs).length>4?`<p style="color:#9AA2B5;font-size:11px;font-style:italic;margin-top:6px">...${Object.keys(prs).length-4} more settings</p>`:''}<div class="rbadge">Total: ${Object.keys(prs).length} fields</div>`:''}`;
    ftr.innerHTML=cbtn('Close');
  }

  else if(which==='support'){
    ttl.textContent=t('supportDev');
    body.innerHTML=`
      <span class="coffee">â˜•</span>
      <p class="btxt" style="text-align:center">${t('supportBody')}</p>
      <button class="btn borg" onclick="window.open('https://ko-fi.com/3MFix','_blank');suppShown=true;ls.set('3f-sup',true);closeModal();setTimeout(resetApp,300)">${t('buyCoffee')}</button>
      <span class="dismiss" onclick="suppShown=true;ls.set('3f-sup',true);closeModal();setTimeout(resetApp,300)">${t('maybeLater')}</span>`;
    ftr.style.display='none';
  }

  else if(which==='about'){
    ttl.textContent='About';
    body.innerHTML=`
      <div class="alogo">3MFix</div><div class="aver">Version 1.0.0</div>
      <p class="btxt">A powerful tool for managing 3MF printer configurations. Extract, modify, and swap printer settings with ease.</p>
      <div class="sttl">Features</div>
      ${['Extract printer, filament, and process settings from .3mf files','Save and manage multiple printer configurations','Swap printer settings between different models','Selectively remove printer, filament, or process data','Automatic backup and one-tap restore','Multi-language support: English, EspaÃ±ol, FranÃ§ais, Deutsch'].map(f=>`<div class="fitem"><span>â€¢</span><span>${f}</span></div>`).join('')}
      <div class="supcard"><div class="supttl">Support Development</div><div class="supbody">Built and maintained by one person. A small contribution helps keep it free.</div><button class="btn borg" onclick="window.open('https://ko-fi.com/3MFix','_blank')">Buy Me a Coffee â˜•</button></div>`;
    ftr.innerHTML=cbtn('Close');
  }

  else if(which==='help'){
    ttl.textContent='How to Use 3MFix';
    body.innerHTML=`
      <div class="sttl">Step 1 â€” Select File</div>
      <p class="btxt">Tap "Choose 3MF File" to pick a file, or drag &amp; drop a .3mf file onto the app. The app will automatically extract all printer, filament, and process settings.</p>
      <div class="div"></div>
      <div class="sttl">Step 2 â€” Options</div>
      <p class="btxt">Enable the options you want, then tap Process.</p>
      ${['Change Printer Data â€” replace the file's printer config with a saved one','Remove Printer Data â€” strip all printer settings from the file','Remove Filament Data â€” strip all filament settings','Remove Process Data â€” strip all process/print settings','Remove All Data â€” strip everything at once'].map(o=>`<div class="fitem"><span>â€¢</span><span>${o}</span></div>`).join('')}
      <div class="div"></div>
      <div class="sttl">Action Buttons</div>
      ${['â–¶ Process â€” apply your selected options and rebuild the file','ðŸ“„ Report â€” inspect all extracted data before processing','â†º Reset â€” discard everything and return to file selection','âŸ³ Restore â€” revert the file to its original settings using the automatic backup'].map(o=>`<div class="fitem"><span>â€¢</span><span>${o}</span></div>`).join('')}
      <div class="div"></div>
      <div class="sttl">Step 3 â€” Export</div>
      <p class="btxt">Once processing is complete, tap "Export 3MF" to save the modified file. On iOS you will get a share sheet â€” tap Save to Files to save it to your device.</p>
      <div class="div"></div>
      <div class="sttl" style="color:#8A2BE2">Tips</div>
      ${['Save printer configs in Settings so you can swap them quickly between files','Use Report to verify the extracted data before making any changes','The first time you process a file, a backup is stored inside it â€” Restore uses this','Change Printer is only available when you have a saved printer that differs from the current file'].map(o=>`<div class="fitem"><span>â€¢</span><span>${o}</span></div>`).join('')}`;
    ftr.innerHTML=cbtn('Close');
  }

  else if(which==='faq'){
    ttl.textContent='FAQ';
    const qs=[
      ['Why is "Change Printer" greyed out?','Change Printer is only available when you have at least one saved printer that is different from the printer in the currently loaded file. Save a different printer configuration first, or load a file from a different printer.'],
      ['How do I save a printer configuration?','Load any .3mf file â€” 3MFix will automatically detect the printer and offer to save it. You can manage saved printers in Settings.'],
      ['Does exporting overwrite my original file?','No. Export creates a brand new file with the name you choose. Your original .3mf file is never modified or deleted.'],
      ['What is the backup stored inside the 3MF?','The first time you process a file, 3MFix stores a copy of the original settings inside the archive. The Restore button uses this backup to undo all changes and return to the very first version.'],
      ['Which slicers are supported?','Any slicer that exports standard .3mf files. 3MFix has been tested with Bambu Studio, PrusaSlicer, and Cura.'],
      ['Why did my file fail to load?','Common causes: the file was not exported by a slicer, the file is corrupted or incomplete, or it exceeds the 500 MB size limit. Try re-exporting from your slicer.'],
      ['How do I save the exported file on iOS?','When you tap Export 3MF, an iOS share sheet will appear. Tap "Save to Files" to choose where to save it on your device or iCloud Drive.'],
      ['Why is Remove Filament/Process greyed out?','Those options are only available when the loaded file actually contains filament or process settings. Not all .3mf files include them.'],
    ];
    body.innerHTML=qs.map((q,i)=>`<div class="faqq">${q[0]}</div><p class="faqa">${q[1]}</p>${i<qs.length-1?'<div class="div"></div>':''}`).join('');
    ftr.innerHTML=cbtn('Close');
  }

  else if(which==='contact'){
    ttl.textContent='Get in Touch';
    body.innerHTML=`<p class="btxt">For questions, feedback, or support, please contact us via email.</p>
      <div class="ccard"><div style="font-size:12px;color:#00BFFF;font-weight:600;margin-bottom:6px">Email</div>
      <div style="font-size:15px;color:#9AA2B5;font-style:italic">support@3MFix.com (coming soon)</div></div>`;
    ftr.innerHTML=cbtn('Close');
  }

  ov.classList.add('show');
}

function closeModal(){$('overlay').classList.remove('show');$('mftr').style.display='';}
$('mclose').addEventListener('click',closeModal);
$('overlay').addEventListener('click',e=>{if(e.target===$('overlay'))closeModal();});

// â”€â”€â”€ Settings helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTheme(m){
  theme=m;applyTheme();
  document.querySelectorAll('.topt').forEach((el,i)=>el.classList.toggle('on',['dark','light','system'][i]===m));
}
function setLang(l){
  lang=l; ls.set('3f-lang',l);
  applyLang();
}
function toggleBtnLabels(){
  btnLabels=!btnLabels;applyBtnLabels();
  const t=$('lbltrk');if(t)t.classList.toggle('on',btnLabels);
}

function renderPList(){
  if(!printers.length)return`<p style="color:#9AA2B5;font-style:italic;font-size:13px;padding:16px 0;text-align:center">${t("noPrinters")}</p>`;
  return printers.map(p=>`
    <div class="pcard">
      <div style="flex:1;min-width:0"><div class="pname">${p.printerModel}</div>
        <div class="psub">Nozzle: ${nozzDisp(p.settings)} Â· Bed: ${p.settings.curr_bed_type||'Unknown'}</div></div>
      ${p.isDefault?'<span class="dbadge">Default</span>':''}
      <div class="pacts">
        ${!p.isDefault?`<button class="pact pdef" onclick="setDefPrinter('${p.printerModel.replace(/'/g,"\\'")}')">Set Default</button>`:''}
        <button class="pact pdel" onclick="delPrinter('${p.printerModel.replace(/'/g,"\\'")}')">Delete</button>
      </div>
    </div>`).join('');
}
function setDefPrinter(m){
  printers=printers.map(p=>({...p,isDefault:p.printerModel===m}));
  printers.sort((a,b)=>a.isDefault?-1:b.isDefault?1:a.printerModel.localeCompare(b.printerModel));
  ls.set('3f-printers',printers);
  const el=$('plistel');if(el)el.innerHTML=renderPList();
  renderPSel();
}
function delPrinter(m){
  const wasDef=printers.find(p=>p.printerModel===m)?.isDefault;
  printers=printers.filter(p=>p.printerModel!==m);
  if(wasDef&&printers.length)printers[0].isDefault=true;
  ls.set('3f-printers',printers);
  const el=$('plistel');if(el)el.innerHTML=renderPList();
  renderPSel();
}
function toggleDef(){
  setAsDef=!setAsDef;
  const t=$('deftrk');if(t)t.classList.toggle('on',setAsDef);
}
function savePrinter(){
  const model=pendingPrinter.printer_model||'Unknown';
  if(setAsDef||!printers.length)printers=printers.map(p=>({...p,isDefault:false}));
  printers.push({printerModel:model,isDefault:setAsDef||!printers.length,settings:pendingPrinter});
  printers.sort((a,b)=>a.isDefault?-1:b.isDefault?1:a.printerModel.localeCompare(b.printerModel));
  ls.set('3f-printers',printers);
  pendingPrinter=null;closeModal();renderPSel();
  dis.cp=false;renderToggles();
}
function skipSave(){pendingPrinter=null;closeModal();}

// â”€â”€â”€ Wire up buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Debug
$('debugBtn').addEventListener('click',()=>{
  const con = $('debugCon');
  con.style.display = 'block';
  const lines = [];
  lines.push('vendor: ' + navigator.vendor);
  lines.push('UA: ' + navigator.userAgent.slice(0,80));
  lines.push('navigator.share: ' + (typeof navigator.share));
  lines.push('navigator.canShare: ' + (typeof navigator.canShare));
  lines.push('ontouchstart: ' + ('ontouchstart' in window));
  lines.push('isSecure: ' + (location.protocol === 'https:' || location.protocol === 'file:'));
  if(navigator.canShare){
    try{
      const testFile = new File(['test'],'test.3mf',{type:'application/octet-stream'});
      lines.push('canShare file: ' + navigator.canShare({files:[testFile]}));
    }catch(e){ lines.push('canShare error: '+e.message); }
  }
  con.innerHTML = lines.map(l=>`<div class="li">Â· ${l}</div>`).join('');
});

$('settingsBtn').addEventListener('click',()=>showModal('settings'));
$('processBtn').addEventListener('click',()=>processFile(false));
$('reportBtn').addEventListener('click',()=>showModal('report'));
$('resetBtn').addEventListener('click',resetApp);
$('restoreBtn').addEventListener('click',restoreFile);
$('exportBtn').addEventListener('click',exportFile);
</script>

</body>
</html>